<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ Kawaii Task Manager</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFB6C1">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Floating hearts animation */
        .heart {
            position: fixed;
            font-size: 20px;
            animation: float 4s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }

        h1 {
            text-align: center;
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #999;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .auth-section {
            margin-bottom: 30px;
        }

        .auth-section input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .auth-section input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .auth-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-signup {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-login {
            background: #f0f0f0;
            color: #333;
        }

        .btn-signup:hover, .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            margin-bottom: 20px;
        }

        .btn-logout {
            background: white;
            color: #764ba2;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            transform: scale(1.05);
        }

        .task-input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #taskInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        #taskInput:focus {
            outline: none;
            border-color: #667eea;
        }

        #addTaskBtn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        #addTaskBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .task-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            position: relative;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .task-item.completed {
            opacity: 0.6;
            background: #e8f5e9;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .task-text {
            flex: 1;
            font-size: 16px;
            word-break: break-word;
        }

        .task-text.completed {
            text-decoration: line-through;
            color: #999;
        }

        .task-text.editing {
            background: white;
            border: 2px solid #667eea;
            padding: 8px;
            border-radius: 8px;
            outline: none;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .btn-edit, .btn-save, .btn-cancel, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #fff3cd;
            color: #856404;
        }

        .btn-save {
            background: #d4edda;
            color: #155724;
        }

        .btn-cancel {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-delete {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-edit:hover, .btn-save:hover, .btn-cancel:hover, .btn-delete:hover {
            transform: scale(1.05);
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-emoji {
            font-size: 48px;
            margin-bottom: 10px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .task-input-section {
                flex-direction: column;
            }
            
            #addTaskBtn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>✨ Kawaii Task Manager</h1>
        <p class="subtitle">Stay organized, stay kawaii! 🌸</p>
        
        <div id="messageContainer"></div>
        
        <!-- Auth Section -->
        <div id="authSection" class="auth-section">
            <input type="text" id="usernameInput" placeholder="Username" autocomplete="username">
            <input type="password" id="passwordInput" placeholder="Password" autocomplete="current-password">
            <div class="auth-buttons">
                <button class="btn-signup" onclick="signup()">Sign Up 🌟</button>
                <button class="btn-login" onclick="login()">Login 💖</button>
            </div>
        </div>
        
        <!-- User Info Section -->
        <div id="userSection" class="hidden">
            <div class="user-info">
                <span>Welcome, <strong id="currentUsername"></strong>! 🎀</span>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
            
            <!-- Task Input -->
            <div class="task-input-section">
                <input type="text" id="taskInput" placeholder="Add a new task... ✨" onkeypress="if(event.key==='Enter') addTask()">
                <button id="addTaskBtn" onclick="addTask()">Add ➕</button>
            </div>
            
            <!-- Tasks List -->
            <div id="tasksList"></div>
            
            <!-- Empty State -->
            <div id="emptyState" class="empty-state hidden">
                <div class="empty-state-emoji">🌸</div>
                <p>No tasks yet! Add one above to get started~ 💕</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDMfj9uF9uuLxO0JCqhDO7rEbAKqYdY5r8",
            authDomain: "kawaii-task-manager.firebaseapp.com",
            projectId: "kawaii-task-manager",
            storageBucket: "kawaii-task-manager.firebasestorage.app",
            messagingSenderId: "488991916932",
            appId: "1:488991916932:web:aeca8caf571cfed5eeb75f"
        };

        let db;
        let currentUser = null;
        let firebaseError = null;

        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log('✅ Firebase initialized successfully!');
        } catch (error) {
            firebaseError = `Firebase initialization error: ${error.message}`;
            console.error('❌ Firebase Error:', error);
        }

        // Create floating hearts
        function createHeart() {
            const heart = document.createElement('div');
            heart.className = 'heart';
            heart.innerHTML = ['💕', '💖', '💗', '💝', '🌸', '🌺', '🎀'][Math.floor(Math.random() * 7)];
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.animationDuration = (Math.random() * 3 + 3) + 's';
            heart.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 7000);
        }

        setInterval(createHeart, 2000);

        // Show message
        function showMessage(message, type = 'error') {
            const container = document.getElementById('messageContainer');
            const div = document.createElement('div');
            div.className = type === 'error' ? 'error-message' : 'success-message';
            div.textContent = message;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Hash password (simple hash for demo)
        async function hashPassword(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Sign up
        async function signup() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!username || !password) {
                showMessage('Please enter both username and password! 🙏', 'error');
                return;
            }

            if (username.length < 3) {
                showMessage('Username must be at least 3 characters! 📝', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('Password must be at least 6 characters! 🔒', 'error');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(username).get();
                if (userDoc.exists) {
                    showMessage('Username already exists! Try logging in~ 💫', 'error');
                    return;
                }

                const passwordHash = await hashPassword(password);
                await db.collection('users').doc(username).set({
                    username: username,
                    passwordHash: passwordHash,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage('Account created successfully! 🎉', 'success');
                setTimeout(() => login(), 1000);
            } catch (error) {
                console.error('Signup error:', error);
                showMessage('Signup failed: ' + error.message, 'error');
            }
        }

        // Login
        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!username || !password) {
                showMessage('Please enter both username and password! 🙏', 'error');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(username).get();
                if (!userDoc.exists) {
                    showMessage('User not found! Please sign up first~ 🌟', 'error');
                    return;
                }

                const passwordHash = await hashPassword(password);
                const userData = userDoc.data();

                if (userData.passwordHash !== passwordHash) {
                    showMessage('Incorrect password! Try again~ 🔐', 'error');
                    return;
                }

                currentUser = username;
                localStorage.setItem('currentUser', username);
                showMessage('Welcome back! 💖', 'success');
                showUserSection();
                loadTasks();
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Login failed: ' + error.message, 'error');
            }
        }

        // Logout
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
            showMessage('Logged out successfully! See you soon~ 👋', 'success');
        }

        // Show user section
        function showUserSection() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('currentUsername').textContent = currentUser;
        }

        // Add task
        async function addTask() {
            const input = document.getElementById('taskInput');
            const taskText = input.value.trim();

            if (!taskText) {
                showMessage('Please enter a task! ✍️', 'error');
                return;
            }

            try {
                await db.collection('tasks').add({
                    text: taskText,
                    completed: false,
                    username: currentUser,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    score: calculateScore(taskText)
                });

                input.value = '';
                showMessage('Task added! 🎀', 'success');
                loadTasks();
            } catch (error) {
                console.error('Add task error:', error);
                showMessage('Failed to add task: ' + error.message, 'error');
            }
        }

        // Calculate priority score (hidden from user)
        function calculateScore(text) {
            let score = 0;
            const urgentWords = ['urgent', 'asap', 'important', 'critical', 'now', '!!!', 'emergency'];
            const lowercaseText = text.toLowerCase();
            
            urgentWords.forEach(word => {
                if (lowercaseText.includes(word)) score += 10;
            });
            
            if (text.includes('!')) score += text.split('!').length - 1;
            
            return score;
        }

        // Load tasks
        async function loadTasks() {
            try {
                const snapshot = await db.collection('tasks')
                    .where('username', '==', currentUser)
                    .orderBy('createdAt', 'desc')
                    .get();

                const tasksList = document.getElementById('tasksList');
                const emptyState = document.getElementById('emptyState');
                tasksList.innerHTML = '';

                if (snapshot.empty) {
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');

                snapshot.forEach(doc => {
                    const task = doc.data();
                    const taskElement = createTaskElement(doc.id, task);
                    tasksList.appendChild(taskElement);
                });
            } catch (error) {
                console.error('Load tasks error:', error);
                showMessage('Failed to load tasks: ' + error.message, 'error');
            }
        }

        // Create task element
        function createTaskElement(id, task) {
            const div = document.createElement('div');
            div.className = 'task-item' + (task.completed ? ' completed' : '');
            div.id = `task-${id}`;

            div.innerHTML = `
                <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} 
                       onchange="toggleTask('${id}', this.checked)">
                <span class="task-text ${task.completed ? 'completed' : ''}" id="text-${id}">${task.text}</span>
                <div class="task-actions">
                    <button class="btn-edit" onclick="editTask('${id}')">Edit ✏️</button>
                    <button class="btn-delete" onclick="deleteTask('${id}')">Delete 🗑️</button>
                </div>
            `;

            return div;
        }

        // Edit task
        function editTask(id) {
            const textElement = document.getElementById(`text-${id}`);
            const originalText = textElement.textContent;
            const taskElement = document.getElementById(`task-${id}`);
            
            // Create input field
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalText;
            input.className = 'task-text editing';
            input.style.flex = '1';
            
            // Replace text with input
            textElement.replaceWith(input);
            input.focus();
            input.select();
            
            // Update buttons
            const actionsDiv = taskElement.querySelector('.task-actions');
            actionsDiv.innerHTML = `
                <button class="btn-save" onclick="saveTask('${id}')">Save ✓</button>
                <button class="btn-cancel" onclick="cancelEdit('${id}', '${originalText.replace(/'/g, "\\'")}')">Cancel ✗</button>
            `;
            
            // Save on Enter key
            input.onkeypress = (e) => {
                if (e.key === 'Enter') saveTask(id);
                if (e.key === 'Escape') cancelEdit(id, originalText);
            };
        }

        // Save edited task
        async function saveTask(id) {
            const input = document.querySelector(`#task-${id} input.editing`);
            const newText = input.value.trim();
            
            if (!newText) {
                showMessage('Task cannot be empty! ✍️', 'error');
                return;
            }
            
            try {
                await db.collection('tasks').doc(id).update({
                    text: newText,
                    score: calculateScore(newText)
                });
                
                showMessage('Task updated! 💫', 'success');
                loadTasks();
            } catch (error) {
                console.error('Save task error:', error);
                showMessage('Failed to save task: ' + error.message, 'error');
            }
        }

        // Cancel editing
        function cancelEdit(id, originalText) {
            loadTasks(); // Reload to restore original state
        }

        // Toggle task completion
        async function toggleTask(id, completed) {
            try {
                await db.collection('tasks').doc(id).update({
                    completed: completed
                });
                loadTasks();
            } catch (error) {
                console.error('Toggle task error:', error);
                showMessage('Failed to update task: ' + error.message, 'error');
            }
        }

        // Delete task
        async function deleteTask(id) {
            if (!confirm('Are you sure you want to delete this task? 🗑️')) {
                return;
            }

            try {
                await db.collection('tasks').doc(id).delete();
                showMessage('Task deleted! 🌟', 'success');
                loadTasks();
            } catch (error) {
                console.error('Delete task error:', error);
                showMessage('Failed to delete task: ' + error.message, 'error');
            }
        }

        // Check for saved session on load
        window.onload = function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                showUserSection();
                loadTasks();
            }
        };
    </script>
</body>
</html>