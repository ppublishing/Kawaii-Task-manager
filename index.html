<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kawaii Cat Task Manager üê±</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#a855f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cat Tasks">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Nunito', sans-serif;
        }
        
        .cat-bounce {
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .paw-print {
            opacity: 0.1;
            position: absolute;
            font-size: 24px;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0); }
            to { opacity: 0.1; transform: scale(1); }
        }
        
        .sparkle {
            animation: sparkle 1.5s ease-in-out infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .priority-border {
            transition: border-color 0.3s ease;
        }

        .subtask-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .subtask-list.open {
            max-height: 2000px;
        }

        .collapse-button {
            transition: transform 0.3s ease;
        }

        .collapse-button.open {
            transform: rotate(180deg);
        }

        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeInOverlay 0.3s ease-in;
        }

        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .celebration-box {
            background: white;
            padding: 3rem;
            border-radius: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .yay-text {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(45deg, #ec4899, #a855f7, #3b82f6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 2s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .dancing-cats {
            display: flex;
            justify-content: center;
            gap: 1rem;
            font-size: 4rem;
            margin: 1rem 0;
        }

        .dancing-cat {
            animation: dance 0.6s ease-in-out infinite;
        }

        .dancing-cat:nth-child(1) {
            animation-delay: 0s;
        }

        .dancing-cat:nth-child(2) {
            animation-delay: 0.15s;
        }

        .dancing-cat:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes dance {
            0%, 100% {
                transform: translateY(0) rotate(0deg) scale(1);
            }
            25% {
                transform: translateY(-20px) rotate(-10deg) scale(1.1);
            }
            50% {
                transform: translateY(0) rotate(0deg) scale(1);
            }
            75% {
                transform: translateY(-20px) rotate(10deg) scale(1.1);
            }
        }

        .confetti {
            position: absolute;
            font-size: 2rem;
            animation: confettiFall 3s linear;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .celebration-message {
            font-size: 1.5rem;
            font-weight: bold;
            color: #6b7280;
            margin-top: 1rem;
        }

        .subtask-border {
            transition: border-color 0.3s ease;
        }

        /* Mobile-optimized edit modal */
        .edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 1rem;
        }

        .edit-modal {
            background: white;
            border-radius: 1.5rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 640px) {
            .edit-modal {
                max-height: 80vh;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // üî• REPLACE THIS WITH YOUR FIREBASE CONFIG
       const firebaseConfig = {
  apiKey: "AIzaSyDC6-FAGsBrCWZ6yiKM3O-7G7m6LwWhdDk",
  authDomain: "nekodo-dc4e5.firebaseapp.com",
  projectId: "nekodo-dc4e5",
  storageBucket: "nekodo-dc4e5.firebasestorage.app",
  messagingSenderId: "735058315811",
  appId: "1:735058315811:web:55274dd5c2d70f789a7f96"
};

        // Initialize Firebase
        let db = null;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
        } catch (error) {
            console.log("Firebase not configured yet");
        }

        // Safe localStorage helper
        const safeLocalStorage = {
            getItem: (key) => {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    return null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    // Silently fail
                }
            },
            removeItem: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    // Silently fail
                }
            }
        };

        // Simple hash function for passwords (NOT secure for production!)
        const simpleHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        };

        // Celebration Component
        function Celebration({ onClose }) {
            const [confetti, setConfetti] = useState([]);

            useEffect(() => {
                const confettiEmojis = ['‚ú®', 'üéâ', 'üéä', '‚≠ê', 'üí´', 'üåü', 'üéà', 'üéÄ', 'üíñ', 'üêæ'];
                const newConfetti = [];
                
                for (let i = 0; i < 30; i++) {
                    newConfetti.push({
                        id: i,
                        emoji: confettiEmojis[Math.floor(Math.random() * confettiEmojis.length)],
                        left: Math.random() * 100,
                        delay: Math.random() * 2
                    });
                }
                
                setConfetti(newConfetti);

                const timer = setTimeout(() => {
                    onClose();
                }, 3000);

                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className="celebration-overlay" onClick={onClose}>
                    {confetti.map(c => (
                        <div
                            key={c.id}
                            className="confetti"
                            style={{
                                left: `${c.left}%`,
                                animationDelay: `${c.delay}s`
                            }}
                        >
                            {c.emoji}
                        </div>
                    ))}
                    
                    <div className="celebration-box" onClick={(e) => e.stopPropagation()}>
                        <div className="yay-text">Yay!</div>
                        
                        <div className="dancing-cats">
                            <div className="dancing-cat">üò∏</div>
                            <div className="dancing-cat">üéâ</div>
                            <div className="dancing-cat">üò∫</div>
                        </div>
                        
                        <div className="celebration-message">
                            Task completed! üåü
                        </div>
                    </div>
                </div>
            );
        }

        // Edit Modal Component for Mobile
        function EditModal({ title, text, date, onSave, onCancel }) {
            const [editText, setEditText] = useState(text);
            const [editDate, setEditDate] = useState(date || '');

            const handleSave = () => {
                onSave(editText, editDate);
            };

            return (
                <div className="edit-modal-overlay" onClick={onCancel}>
                    <div className="edit-modal" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800 mb-4">{title}</h3>
                        
                        <div className="space-y-3">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">
                                    Text
                                </label>
                                <textarea
                                    value={editText}
                                    onChange={(e) => setEditText(e.target.value)}
                                    className="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-pink-400 text-base resize-none"
                                    rows="3"
                                    autoFocus
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">
                                    Due Date (Optional)
                                </label>
                                <input
                                    type="date"
                                    value={editDate}
                                    onChange={(e) => setEditDate(e.target.value)}
                                    className="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-pink-400 text-base"
                                />
                            </div>

                            <div className="flex gap-3 pt-2">
                                <button
                                    onClick={handleSave}
                                    className="flex-1 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 font-bold text-base shadow-lg"
                                >
                                    ‚úì Save
                                </button>
                                <button
                                    onClick={onCancel}
                                    className="flex-1 py-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 font-bold text-base shadow-lg"
                                >
                                    ‚úï Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Login/Signup Component
        function LoginScreen({ onLogin }) {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                
                if (!username.trim() || !password.trim()) {
                    setError('Please enter both username and password');
                    return;
                }

                if (username.length < 3) {
                    setError('Username must be at least 3 characters');
                    return;
                }

                if (password.length < 4) {
                    setError('Password must be at least 4 characters');
                    return;
                }

                if (!db) {
                    setError('Firebase not configured. Please check your setup.');
                    return;
                }

                setLoading(true);

                try {
                    const usernameLower = username.toLowerCase().trim();
                    const passwordHash = simpleHash(password);

                    // Check if user exists
                    const userDoc = await db.collection('users').doc(usernameLower).get();

                    if (isLogin) {
                        // LOGIN
                        if (!userDoc.exists) {
                            setError('Username not found. Please sign up first!');
                            setLoading(false);
                            return;
                        }

                        const userData = userDoc.data();
                        if (userData.passwordHash !== passwordHash) {
                            setError('Incorrect password');
                            setLoading(false);
                            return;
                        }

                        // Login successful!
                        safeLocalStorage.setItem('currentUser', usernameLower);
                        safeLocalStorage.setItem('userSession', passwordHash);
                        onLogin(usernameLower);
                    } else {
                        // SIGNUP
                        if (userDoc.exists) {
                            setError('Username already taken. Please choose another one!');
                            setLoading(false);
                            return;
                        }

                        // Create new user
                        await db.collection('users').doc(usernameLower).set({
                            username: usernameLower,
                            passwordHash: passwordHash,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Auto-login after signup
                        safeLocalStorage.setItem('currentUser', usernameLower);
                        safeLocalStorage.setItem('userSession', passwordHash);
                        onLogin(usernameLower);
                    }
                } catch (error) {
                    console.error('Auth error:', error);
                    setError('Something went wrong. Please try again.');
                }

                setLoading(false);
            };

            return (
                <div className="min-h-screen p-4 flex items-center justify-center relative overflow-hidden" style={{background: 'linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 50%, #c7d2fe 100%)'}}>
                    {/* Floating paw prints */}
                    <div className="paw-print" style={{top: '10%', left: '5%'}}>üêæ</div>
                    <div className="paw-print" style={{top: '20%', right: '10%'}}>üêæ</div>
                    <div className="paw-print" style={{bottom: '15%', left: '15%'}}>üêæ</div>
                    <div className="paw-print" style={{bottom: '25%', right: '5%'}}>üêæ</div>

                    <div className="w-full max-w-md">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 relative overflow-hidden">
                            {/* Decorative cat */}
                            <div className="absolute top-0 right-0 text-6xl cat-bounce opacity-20">
                                üê±
                            </div>

                            {/* Header */}
                            <div className="text-center mb-8">
                                <div className="text-7xl mb-4 cat-bounce">üò∫</div>
                                <h1 className="text-4xl font-bold bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 bg-clip-text text-transparent mb-2">
                                    Kawaii Tasks
                                </h1>
                                <p className="text-gray-600 text-lg">
                                    {isLogin ? 'Welcome back! üåü' : 'Join the fun! ‚ú®'}
                                </p>
                            </div>

                            {/* Form */}
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">
                                        Username
                                    </label>
                                    <input
                                        type="text"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        placeholder="Choose a cool username"
                                        className="w-full px-4 py-3 border-3 border-purple-300 rounded-2xl focus:outline-none focus:border-pink-400 text-lg font-semibold"
                                        disabled={loading}
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="Enter password"
                                        className="w-full px-4 py-3 border-3 border-purple-300 rounded-2xl focus:outline-none focus:border-pink-400 text-lg font-semibold"
                                        disabled={loading}
                                    />
                                </div>

                                {error && (
                                    <div className="bg-red-100 border-2 border-red-400 text-red-700 px-4 py-3 rounded-2xl text-sm font-semibold">
                                        {error}
                                    </div>
                                )}

                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full py-4 bg-gradient-to-r from-pink-400 to-purple-500 text-white rounded-2xl hover:from-pink-500 hover:to-purple-600 font-bold text-lg shadow-lg transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {loading ? '‚è≥ Loading...' : (isLogin ? 'üéØ Login' : '‚ú® Sign Up')}
                                </button>
                            </form>

                            {/* Toggle Login/Signup */}
                            <div className="mt-6 text-center">
                                <button
                                    onClick={() => {
                                        setIsLogin(!isLogin);
                                        setError('');
                                    }}
                                    className="text-purple-600 hover:text-pink-600 font-bold"
                                    disabled={loading}
                                >
                                    {isLogin ? "Don't have an account? Sign up! üéâ" : 'Already have an account? Login! üëã'}
                                </button>
                            </div>

                            {/* Info */}
                            <div className="mt-6 bg-purple-50 rounded-2xl p-4">
                                <p className="text-xs text-gray-600 text-center">
                                    <strong>üí° Tip:</strong> Your username is your unique ID. You can access your tasks from any device by logging in!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Main Task Manager Component
        function TaskManager({ username, onLogout }) {
            const [tasks, setTasks] = useState([]);
            const [newTask, setNewTask] = useState('');
            const [newDueDate, setNewDueDate] = useState('');
            const [showCompleted, setShowCompleted] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [catMood, setCatMood] = useState('happy');
            const [expandedTasks, setExpandedTasks] = useState({});
            const [addingSubtaskTo, setAddingSubtaskTo] = useState(null);
            const [newSubtask, setNewSubtask] = useState('');
            const [newSubtaskDate, setNewSubtaskDate] = useState('');
            const [showCelebration, setShowCelebration] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [editingSubtask, setEditingSubtask] = useState(null);

            const calculatePriority = (taskText, dueDate) => {
                let priority = 0;
                
                if (dueDate) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const due = new Date(dueDate);
                    due.setHours(0, 0, 0, 0);
                    const daysUntilDue = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                    
                    // Much stronger date-based priority
                    if (daysUntilDue < 0) priority += 100;  // Overdue = MAX priority
                    else if (daysUntilDue === 0) priority += 95;  // Today
                    else if (daysUntilDue === 1) priority += 90;  // Tomorrow
                    else if (daysUntilDue === 2) priority += 85;  // 2 days
                    else if (daysUntilDue === 3) priority += 80;  // 3 days
                    else if (daysUntilDue <= 7) priority += 70;   // This week
                    else if (daysUntilDue <= 14) priority += 50;  // Next 2 weeks
                    else if (daysUntilDue <= 30) priority += 30;  // This month
                    else if (daysUntilDue <= 90) priority += 15;  // Next 3 months
                    else priority += 5;  // Far future
                } else {
                    priority += 10;  // No date = lower priority
                }
                
                const taskLower = taskText.toLowerCase();
                const urgentKeywords = ['urgent', 'asap', 'emergency', 'critical', 'deadline', 'important'];
                const highPriorityKeywords = ['meeting', 'call', 'appointment', 'interview', 'presentation', 'exam', 'test'];
                
                let keywordScore = 0;
                urgentKeywords.forEach(keyword => {
                    if (taskLower.includes(keyword)) keywordScore += 20;
                });
                
                if (keywordScore === 0) {
                    highPriorityKeywords.forEach(keyword => {
                        if (taskLower.includes(keyword)) keywordScore += 10;
                    });
                }
                
                priority += keywordScore;
                
                // Small bonus for shorter tasks
                if (taskText.length < 20) priority += 3;
                else if (taskText.length < 40) priority += 1;
                
                return Math.min(priority, 150);  // Cap at 150
            };

            const recalculateTaskPriority = (task) => {
                // Calculate base priority for main task
                const mainPriority = calculatePriority(task.text, task.dueDate);
                
                // If task has subtasks, find the HIGHEST priority among uncompleted subtasks
                if (task.subtasks && task.subtasks.length > 0) {
                    const activeSubtasks = task.subtasks.filter(st => !st.completed);
                    
                    if (activeSubtasks.length > 0) {
                        const subtaskPriorities = activeSubtasks.map(st => 
                            calculatePriority(st.text, st.dueDate)
                        );
                        
                        const maxSubtaskPriority = Math.max(...subtaskPriorities);
                        
                        // IMPORTANT: Use the HIGHER priority between main task and subtasks
                        // This ensures urgent subtasks bubble up the parent task
                        return Math.max(mainPriority, maxSubtaskPriority);
                    }
                }
                
                return mainPriority;
            };

            // Load tasks from Firebase and recalculate priorities
            useEffect(() => {
                if (!db) return;

                const unsubscribe = db.collection('tasks')
                    .where('username', '==', username)
                    .onSnapshot(snapshot => {
                        const tasksData = [];
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            
                            // Recalculate priorities for all subtasks
                            const updatedSubtasks = (data.subtasks || []).map(st => ({
                                ...st,
                                priority: calculatePriority(st.text, st.dueDate)
                            }));
                            
                            // Recalculate main task priority considering subtasks
                            const taskWithUpdatedSubtasks = {
                                ...data,
                                subtasks: updatedSubtasks
                            };
                            
                            const finalPriority = recalculateTaskPriority(taskWithUpdatedSubtasks);
                            
                            tasksData.push({ 
                                id: doc.id, 
                                ...taskWithUpdatedSubtasks,
                                priority: finalPriority
                            });
                        });
                        
                        // Sort by priority (highest first)
                        tasksData.sort((a, b) => (b.priority || 0) - (a.priority || 0));
                        
                        setTasks(tasksData);
                    });

                return () => unsubscribe();
            }, [username]);

            // Update cat mood
            useEffect(() => {
                const activeTasks = tasks.filter(t => !t.completed);
                const overdueTasks = activeTasks.filter(t => {
                    if (!t.dueDate) return false;
                    return new Date(t.dueDate) < new Date();
                });

                if (activeTasks.length === 0) setCatMood('excited');
                else if (overdueTasks.length > 0) setCatMood('worried');
                else if (activeTasks.length > 5) setCatMood('stressed');
                else setCatMood('happy');
            }, [tasks]);

            const addTask = async () => {
                if (!newTask.trim()) return;
                if (!db) {
                    alert('Please configure Firebase first!');
                    return;
                }
                
                setSyncing(true);
                const priority = calculatePriority(newTask, newDueDate);
                
                const task = {
                    text: newTask,
                    dueDate: newDueDate,
                    completed: false,
                    priority: priority,
                    username: username,
                    subtasks: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                try {
                    await db.collection('tasks').add(task);
                    setNewTask('');
                    setNewDueDate('');
                } catch (error) {
                    console.error('Error adding task:', error);
                    alert('Error adding task. Please try again.');
                }
                setSyncing(false);
            };

            const saveTaskEdit = async (text, date) => {
                if (!text.trim()) return;
                if (!db) return;

                setSyncing(true);
                const task = tasks.find(t => t.id === editingTask);
                const priority = recalculateTaskPriority({
                    ...task,
                    text: text,
                    dueDate: date
                });

                try {
                    await db.collection('tasks').doc(editingTask).update({
                        text: text,
                        dueDate: date,
                        priority: priority
                    });
                    setEditingTask(null);
                } catch (error) {
                    console.error('Error updating task:', error);
                }
                setSyncing(false);
            };

            const addSubtask = async (taskId) => {
                if (!newSubtask.trim()) return;
                if (!db) return;

                setSyncing(true);
                const task = tasks.find(t => t.id === taskId);
                const subtasks = task.subtasks || [];
                
                const newSubtaskObj = {
                    id: Date.now().toString(),
                    text: newSubtask,
                    dueDate: newSubtaskDate,
                    completed: false,
                    priority: calculatePriority(newSubtask, newSubtaskDate)
                };

                const updatedSubtasks = [...subtasks, newSubtaskObj];
                const newTaskPriority = recalculateTaskPriority({
                    ...task,
                    subtasks: updatedSubtasks
                });

                try {
                    await db.collection('tasks').doc(taskId).update({
                        subtasks: updatedSubtasks,
                        priority: newTaskPriority
                    });
                    setNewSubtask('');
                    setNewSubtaskDate('');
                    setAddingSubtaskTo(null);
                } catch (error) {
                    console.error('Error adding subtask:', error);
                }
                setSyncing(false);
            };

            const saveSubtaskEdit = async (text, date) => {
                if (!text.trim()) return;
                if (!db) return;

                setSyncing(true);
                const task = tasks.find(t => t.id === editingSubtask.taskId);
                const updatedSubtasks = task.subtasks.map(st => 
                    st.id === editingSubtask.subtaskId 
                        ? { 
                            ...st, 
                            text: text,
                            dueDate: date,
                            priority: calculatePriority(text, date)
                          } 
                        : st
                );

                const newTaskPriority = recalculateTaskPriority({
                    ...task,
                    subtasks: updatedSubtasks
                });

                try {
                    await db.collection('tasks').doc(editingSubtask.taskId).update({
                        subtasks: updatedSubtasks,
                        priority: newTaskPriority
                    });
                    setEditingSubtask(null);
                } catch (error) {
                    console.error('Error updating subtask:', error);
                }
                setSyncing(false);
            };

            const toggleSubtask = async (taskId, subtaskId) => {
                if (!db) return;
                setSyncing(true);
                
                const task = tasks.find(t => t.id === taskId);
                const subtask = task.subtasks.find(st => st.id === subtaskId);
                const wasCompleted = subtask.completed;
                
                const updatedSubtasks = task.subtasks.map(st => 
                    st.id === subtaskId ? { ...st, completed: !st.completed } : st
                );

                const newTaskPriority = recalculateTaskPriority({
                    ...task,
                    subtasks: updatedSubtasks
                });

                try {
                    await db.collection('tasks').doc(taskId).update({
                        subtasks: updatedSubtasks,
                        priority: newTaskPriority
                    });
                    
                    if (!wasCompleted) {
                        setShowCelebration(true);
                    }
                } catch (error) {
                    console.error('Error updating subtask:', error);
                }
                setSyncing(false);
            };

            const deleteSubtask = async (taskId, subtaskId) => {
                if (!db) return;
                setSyncing(true);
                
                const task = tasks.find(t => t.id === taskId);
                const updatedSubtasks = task.subtasks.filter(st => st.id !== subtaskId);

                const newTaskPriority = recalculateTaskPriority({
                    ...task,
                    subtasks: updatedSubtasks
                });

                try {
                    await db.collection('tasks').doc(taskId).update({
                        subtasks: updatedSubtasks,
                        priority: newTaskPriority
                    });
                } catch (error) {
                    console.error('Error deleting subtask:', error);
                }
                setSyncing(false);
            };

            const toggleTask = async (id) => {
                if (!db) return;
                setSyncing(true);
                const task = tasks.find(t => t.id === id);
                const wasCompleted = task.completed;
                
                try {
                    await db.collection('tasks').doc(id).update({
                        completed: !task.completed
                    });
                    
                    if (!wasCompleted) {
                        setShowCelebration(true);
                    }
                } catch (error) {
                    console.error('Error updating task:', error);
                }
                setSyncing(false);
            };

            const deleteTask = async (id) => {
                if (!db) return;
                setSyncing(true);
                try {
                    await db.collection('tasks').doc(id).delete();
                } catch (error) {
                    console.error('Error deleting task:', error);
                }
                setSyncing(false);
            };

            const toggleTaskExpansion = (taskId) => {
                setExpandedTasks(prev => ({
                    ...prev,
                    [taskId]: !prev[taskId]
                }));
            };

            const handleLogout = () => {
                if (confirm('Are you sure you want to logout? üê±')) {
                    safeLocalStorage.removeItem('currentUser');
                    safeLocalStorage.removeItem('userSession');
                    onLogout();
                }
            };

            const getPriorityBorderColor = (priority) => {
                if (priority >= 90) return '#dc2626';  // Extreme urgency
                if (priority >= 75) return '#ef4444';  // Very high
                if (priority >= 60) return '#f87171';  // High
                if (priority >= 45) return '#fb7185';  // Medium-high
                if (priority >= 30) return '#f472b6';  // Medium
                if (priority >= 15) return '#e879f9';  // Low
                return '#f0abfc';  // Very low
            };

            const getPriorityColor = (priority) => {
                if (priority >= 90) return 'bg-red-50';
                if (priority >= 75) return 'bg-red-50';
                if (priority >= 60) return 'bg-rose-50';
                if (priority >= 45) return 'bg-rose-50';
                if (priority >= 30) return 'bg-pink-50';
                if (priority >= 15) return 'bg-fuchsia-50';
                return 'bg-purple-50';
            };

            const getPriorityLabel = (priority) => {
                if (priority >= 90) return 'üî• Critical';
                if (priority >= 75) return '‚ö†Ô∏è Very High';
                if (priority >= 60) return '‚≠ê High';
                if (priority >= 45) return 'üí´ Medium-High';
                if (priority >= 30) return 'üå∏ Medium';
                if (priority >= 15) return '‚ú® Low';
                return 'üåô Very Low';
            };

            const formatDueDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                date.setHours(0, 0, 0, 0);
                
                const diff = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
                
                if (diff < 0) return '‚ö†Ô∏è Overdue';
                if (diff === 0) return 'üìå Today';
                if (diff === 1) return 'üìÖ Tomorrow';
                if (diff === 2) return 'üìÜ In 2 days';
                if (diff <= 7) return `üìÜ In ${diff} days`;
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            };

            const getCatEmoji = () => {
                switch(catMood) {
                    case 'excited': return 'üò∏';
                    case 'worried': return 'üôÄ';
                    case 'stressed': return 'üòø';
                    default: return 'üò∫';
                }
            };

            const getCatMessage = () => {
                switch(catMood) {
                    case 'excited': return 'Yay! All tasks done! Time to play! üéâ';
                    case 'worried': return 'Meow! You have overdue tasks! üò∞';
                    case 'stressed': return 'So many tasks... Let\'s tackle them! üí™';
                    default: return 'Ready to be productive! ‚ú®';
                }
            };

            const activeTasks = tasks.filter(t => !t.completed);
            const completedTasks = tasks.filter(t => t.completed);

            return (
                <div className="min-h-screen p-4 relative overflow-hidden" style={{background: 'linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 50%, #c7d2fe 100%)'}}>
                    {showCelebration && (
                        <Celebration onClose={() => setShowCelebration(false)} />
                    )}

                    {editingTask && (
                        <EditModal
                            title="Edit Task"
                            text={tasks.find(t => t.id === editingTask)?.text || ''}
                            date={tasks.find(t => t.id === editingTask)?.dueDate || ''}
                            onSave={saveTaskEdit}
                            onCancel={() => setEditingTask(null)}
                        />
                    )}

                    {editingSubtask && (
                        <EditModal
                            title="Edit Subtask"
                            text={tasks.find(t => t.id === editingSubtask.taskId)?.subtasks.find(st => st.id === editingSubtask.subtaskId)?.text || ''}
                            date={tasks.find(t => t.id === editingSubtask.taskId)?.subtasks.find(st => st.id === editingSubtask.subtaskId)?.dueDate || ''}
                            onSave={saveSubtaskEdit}
                            onCancel={() => setEditingSubtask(null)}
                        />
                    )}

                    <div className="paw-print" style={{top: '10%', left: '5%'}}>üêæ</div>
                    <div className="paw-print" style={{top: '20%', right: '10%'}}>üêæ</div>
                    <div className="paw-print" style={{bottom: '15%', left: '15%'}}>üêæ</div>
                    <div className="paw-print" style={{bottom: '25%', right: '5%'}}>üêæ</div>
                    
                    <div className="max-w-2xl mx-auto relative">
                        <div className="bg-white rounded-3xl shadow-2xl p-6 mb-6 relative overflow-hidden">
                            <div className="absolute top-0 right-0 text-6xl cat-bounce opacity-20">
                                üê±
                            </div>
                            
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-4 flex-1">
                                    <div className="text-6xl cat-bounce">{getCatEmoji()}</div>
                                    <div className="flex-1">
                                        <h1 className="text-4xl font-bold bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 bg-clip-text text-transparent">
                                            Kawaii Task Manager
                                        </h1>
                                        <p className="text-lg text-gray-600 mt-1">{getCatMessage()}</p>
                                        <p className="text-sm text-purple-600 font-semibold mt-1">
                                            üë§ Logged in as: {username}
                                        </p>
                                    </div>
                                </div>
                                <button
                                    onClick={handleLogout}
                                    className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold text-sm transition-all"
                                >
                                    üö™ Logout
                                </button>
                            </div>
                            
                            {syncing && (
                                <div className="mb-4 text-center">
                                    <span className="text-2xl sparkle inline-block">‚ú® Syncing...</span>
                                </div>
                            )}
                            
                            <div className="space-y-3">
                                <input
                                    type="text"
                                    value={newTask}
                                    onChange={(e) => setNewTask(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && addTask()}
                                    placeholder="What's on your mind? üåü"
                                    className="w-full px-5 py-4 border-3 border-purple-300 rounded-2xl focus:outline-none focus:border-pink-400 text-lg font-semibold shadow-lg"
                                />
                                
                                <div className="flex gap-3">
                                    <div className="flex-1 relative">
                                        <span className="absolute left-4 top-4 text-xl">üìÖ</span>
                                        <input
                                            type="date"
                                            value={newDueDate}
                                            onChange={(e) => setNewDueDate(e.target.value)}
                                            className="w-full pl-12 pr-5 py-4 border-3 border-purple-300 rounded-2xl focus:outline-none focus:border-pink-400 text-lg font-semibold shadow-lg"
                                        />
                                    </div>
                                    
                                    <button
                                        onClick={addTask}
                                        className="px-8 py-4 bg-gradient-to-r from-pink-400 to-purple-500 text-white rounded-2xl hover:from-pink-500 hover:to-purple-600 font-bold text-lg shadow-lg transform hover:scale-105 transition-all"
                                    >
                                        ‚ú® Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-3xl shadow-2xl p-6 mb-6">
                            <div className="flex items-center gap-3 mb-4">
                                <h2 className="text-2xl font-bold text-gray-800">
                                    üìù Active Tasks
                                </h2>
                                <span className="px-3 py-1 bg-purple-200 text-purple-800 rounded-full font-bold">
                                    {activeTasks.length}
                                </span>
                            </div>
                            
                            {activeTasks.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-7xl mb-4 cat-bounce">üò∏</div>
                                    <p className="text-2xl font-bold text-gray-600">All done! You're amazing! üéâ</p>
                                    <p className="text-lg text-gray-500 mt-2">Time for some catnip! üåø</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {activeTasks.map(task => {
                                        const priority = task.priority || 0;
                                        const borderColor = getPriorityBorderColor(priority);
                                        const hasSubtasks = task.subtasks && task.subtasks.length > 0;
                                        const isExpanded = expandedTasks[task.id];
                                        const completedSubtasks = task.subtasks?.filter(st => st.completed).length || 0;
                                        const totalSubtasks = task.subtasks?.length || 0;
                                        
                                        // Sort subtasks by priority (highest first)
                                        const sortedSubtasks = hasSubtasks 
                                            ? [...task.subtasks].sort((a, b) => (b.priority || 0) - (a.priority || 0))
                                            : [];

                                        return (
                                            <div
                                                key={task.id}
                                                className={`priority-border rounded-2xl p-5 transition-all shadow-md hover:shadow-xl ${getPriorityColor(priority)}`}
                                                style={{ 
                                                    borderWidth: '4px',
                                                    borderStyle: 'solid',
                                                    borderColor: borderColor
                                                }}
                                            >
                                                <div className="flex items-start gap-3">
                                                    <button
                                                        onClick={() => toggleTask(task.id)}
                                                        className="mt-1 w-7 h-7 border-3 border-purple-400 rounded-lg hover:border-pink-500 hover:bg-pink-100 flex-shrink-0 transition-all transform hover:scale-110"
                                                    >
                                                    </button>
                                                    
                                                    <div className="flex-1 min-w-0">
                                                        <p className="text-gray-800 font-bold text-lg break-words">{task.text}</p>
                                                        <div className="flex flex-wrap items-center gap-2 mt-2">
                                                            <span className="px-3 py-1 bg-white rounded-full font-bold text-sm shadow-sm">
                                                                {getPriorityLabel(priority)}
                                                            </span>
                                                            {task.dueDate && (
                                                                <span className="text-gray-700 font-semibold text-sm">
                                                                    {formatDueDate(task.dueDate)}
                                                                </span>
                                                            )}
                                                            {hasSubtasks && (
                                                                <span className="text-gray-600 text-sm font-semibold">
                                                                    üìã {completedSubtasks}/{totalSubtasks} subtasks
                                                                </span>
                                                            )}
                                                        </div>

                                                        <div className="mt-3">
                                                            <div className="flex flex-wrap gap-2">
                                                                <button
                                                                    onClick={() => setEditingTask(task.id)}
                                                                    className="text-sm font-bold text-blue-600 hover:text-blue-800"
                                                                >
                                                                    ‚úèÔ∏è Edit
                                                                </button>
                                                                {hasSubtasks && (
                                                                    <button
                                                                        onClick={() => toggleTaskExpansion(task.id)}
                                                                        className="text-sm font-bold text-purple-600 hover:text-pink-600 flex items-center gap-1"
                                                                    >
                                                                        <span className={`collapse-button ${isExpanded ? 'open' : ''}`}>‚ñº</span>
                                                                        {isExpanded ? 'Hide' : 'Show'} subtasks
                                                                    </button>
                                                                )}
                                                                <button
                                                                    onClick={() => setAddingSubtaskTo(addingSubtaskTo === task.id ? null : task.id)}
                                                                    className="text-sm font-bold text-purple-600 hover:text-pink-600"
                                                                >
                                                                    ‚ûï Add subtask
                                                                </button>
                                                            </div>

                                                            {addingSubtaskTo === task.id && (
                                                                <div className="mt-2 space-y-2">
                                                                    <input
                                                                        type="text"
                                                                        value={newSubtask}
                                                                        onChange={(e) => setNewSubtask(e.target.value)}
                                                                        onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && addSubtask(task.id)}
                                                                        placeholder="Subtask name..."
                                                                        className="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-pink-400 text-sm"
                                                                        autoFocus
                                                                    />
                                                                    <div className="flex gap-2">
                                                                        <input
                                                                            type="date"
                                                                            value={newSubtaskDate}
                                                                            onChange={(e) => setNewSubtaskDate(e.target.value)}
                                                                            className="flex-1 px-3 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-pink-400 text-sm"
                                                                        />
                                                                        <button
                                                                            onClick={() => addSubtask(task.id)}
                                                                            className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-pink-500 font-bold text-sm"
                                                                        >
                                                                            Add
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            <div className={`subtask-list ${isExpanded ? 'open' : ''}`}>
                                                                {hasSubtasks && (
                                                                    <div className="mt-3 space-y-2 pl-2 border-l-4 border-purple-200">
                                                                        {sortedSubtasks.map(subtask => {
                                                                            const subtaskPriority = subtask.priority || 0;
                                                                            const subtaskBorderColor = getPriorityBorderColor(subtaskPriority);
                                                                            
                                                                            return (
                                                                                <div 
                                                                                    key={subtask.id} 
                                                                                    className={`subtask-border rounded-lg p-2 ${subtask.completed ? 'bg-gray-50' : 'bg-white'}`}
                                                                                    style={{
                                                                                        borderLeft: `4px solid ${subtaskBorderColor}`
                                                                                    }}
                                                                                >
                                                                                    <div className="flex items-start gap-2">
                                                                                        <button
                                                                                            onClick={() => toggleSubtask(task.id, subtask.id)}
                                                                                            className={`mt-1 w-5 h-5 border-2 rounded flex-shrink-0 flex items-center justify-center ${
                                                                                                subtask.completed 
                                                                                                    ? 'bg-green-500 border-green-500' 
                                                                                                    : 'border-purple-300 hover:border-pink-400'
                                                                                            }`}
                                                                                        >
                                                                                            {subtask.completed && (
                                                                                                <span className="text-white text-xs font-bold">‚úì</span>
                                                                                            )}
                                                                                        </button>
                                                                                        <div className="flex-1 min-w-0">
                                                                                            <span className={`text-sm block ${subtask.completed ? 'line-through text-gray-400' : 'text-gray-700 font-semibold'}`}>
                                                                                                {subtask.text}
                                                                                            </span>
                                                                                            <div className="flex flex-wrap items-center gap-2 mt-1">
                                                                                                <span className="text-xs px-2 py-0.5 bg-white rounded-full font-bold shadow-sm">
                                                                                                    {getPriorityLabel(subtaskPriority)}
                                                                                                </span>
                                                                                                {subtask.dueDate && (
                                                                                                    <span className="text-xs text-gray-600 font-semibold">
                                                                                                        {formatDueDate(subtask.dueDate)}
                                                                                                    </span>
                                                                                                )}
                                                                                            </div>
                                                                                        </div>
                                                                                        <div className="flex gap-1 flex-shrink-0">
                                                                                            <button
                                                                                                onClick={() => setEditingSubtask({ taskId: task.id, subtaskId: subtask.id })}
                                                                                                className="text-lg p-1 hover:scale-110 transition-transform"
                                                                                            >
                                                                                                ‚úèÔ∏è
                                                                                            </button>
                                                                                            <button
                                                                                                onClick={() => deleteSubtask(task.id, subtask.id)}
                                                                                                className="text-lg p-1 hover:scale-110 transition-transform"
                                                                                            >
                                                                                                üóëÔ∏è
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <button
                                                        onClick={() => deleteTask(task.id)}
                                                        className="text-2xl flex-shrink-0 transform hover:scale-125 transition-all"
                                                    >
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        {completedTasks.length > 0 && (
                            <div className="bg-white rounded-3xl shadow-2xl p-6 overflow-hidden">
                                <button
                                    onClick={() => setShowCompleted(!showCompleted)}
                                    className="w-full flex items-center justify-between mb-4 hover:bg-gray-50 p-2 rounded-xl transition-all"
                                >
                                    <div className="flex items-center gap-3">
                                        <h2 className="text-2xl font-bold text-gray-800">
                                            ‚úÖ Completed
                                        </h2>
                                        <span className="px-3 py-1 bg-green-200 text-green-800 rounded-full font-bold">
                                            {completedTasks.length}
                                        </span>
                                    </div>
                                    <span className={`text-2xl transition-transform ${showCompleted ? 'rotate-180' : ''}`}>
                                        ‚ñº
                                    </span>
                                </button>
                                
                                <div className={`subtask-list ${showCompleted ? 'open' : ''}`}>
                                    <div className="space-y-3">
                                        {completedTasks.map(task => (
                                            <div
                                                key={task.id}
                                                className="border-3 border-gray-300 rounded-2xl p-5 bg-gray-50"
                                            >
                                                <div className="flex items-start gap-3">
                                                    <button
                                                        onClick={() => toggleTask(task.id)}
                                                        className="mt-1 w-7 h-7 border-3 border-green-500 bg-green-500 rounded-lg flex-shrink-0 flex items-center justify-center"
                                                    >
                                                        <span className="text-white font-bold">‚úì</span>
                                                    </button>
                                                    
                                                    <div className="flex-1 min-w-0">
                                                        <p className="text-gray-500 line-through font-semibold text-lg break-words">{task.text}</p>
                                                        {task.subtasks && task.subtasks.length > 0 && (
                                                            <div className="mt-2 space-y-1 pl-2 border-l-2 border-gray-300">
                                                                {task.subtasks.map(subtask => (
                                                                    <div key={subtask.id} className="flex items-center gap-2">
                                                                        <span className={`text-sm ${subtask.completed ? 'line-through text-gray-400' : 'text-gray-500'}`}>
                                                                            {subtask.completed ? '‚úì' : '‚óã'} {subtask.text}
                                                                        </span>
                                                                        {subtask.dueDate && (
                                                                            <span className="text-xs text-gray-400">
                                                                                {formatDueDate(subtask.dueDate)}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    <button
                                                        onClick={() => deleteTask(task.id)}
                                                        className="text-2xl flex-shrink-0 transform hover:scale-125 transition-all"
                                                    >
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <div className="text-center mt-8 text-4xl cat-bounce">
                            üêæ
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // Check if user is already logged in
                const savedUser = safeLocalStorage.getItem('currentUser');
                const savedSession = safeLocalStorage.getItem('userSession');
                
                if (savedUser && savedSession) {
                    // Verify session is valid (you could add server-side verification here)
                    setCurrentUser(savedUser);
                }
                
                setLoading(false);
            }, []);

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{background: 'linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 50%, #c7d2fe 100%)'}}>
                        <div className="text-center">
                            <div className="text-7xl mb-4 cat-bounce">üò∫</div>
                            <p className="text-2xl font-bold text-gray-700">Loading...</p>
                        </div>
                    </div>
                );
            }

            if (!currentUser) {
                return <LoginScreen onLogin={setCurrentUser} />;
            }

            return <TaskManager username={currentUser} onLogout={() => setCurrentUser(null)} />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

    <!-- PWA Service Worker Registration with Auto-Update -->
<script>
    if ('serviceWorker' in navigator) {
        let refreshing = false;
        
        // Detect when new service worker is ready
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return;
            refreshing = true;
            console.log('üîÑ New version available! Reloading...');
            window.location.reload();
        });

        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then((registration) => {
                    console.log('‚ú® PWA Service Worker registered!', registration.scope);
                    
                    // Check for updates every 30 seconds
                    setInterval(() => {
                        console.log('üîç Checking for updates...');
                        registration.update();
                    }, 30000);
                    
                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üì¶ New version found! Installing...');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New service worker available, tell user
                                console.log('‚úÖ New version ready!');
                                
                                // Show update notification
                                if (confirm('üéâ New update available! Reload to get the latest version?')) {
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                }
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
        });
    }
</script>
</body>
</html>